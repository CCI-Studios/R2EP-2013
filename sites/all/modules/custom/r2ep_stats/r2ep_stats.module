<?php
define('R2EP_BLOCK_NATIONAL', 'r2ep_national_stats');
define('R2EP_BLOCK_EVENT', 'r2ep_event_stats');
define('R2EP_BLOCK_TEAM', 'r2ep_team_stats');
define('R2EP_BLOCK_RUNNER', 'r2ep_runner_stats');
define('R2EP_BLOCK_THERMOMETER', 'r2ep_block_thermometer');

module_load_include('inc', 'r2ep_stats', 'r2ep_stats.queries');
module_load_include('inc', 'r2ep_stats', 'r2ep_stats.computed');

function r2ep_stats_block_info() {
	$blocks = array();
	$blocks[R2EP_BLOCK_NATIONAL] = array(
		'info' => t('R2EP National Statistics'),
	);
	$blocks[R2EP_BLOCK_EVENT] = array(
		'info' => t('R2EP Event Statistics'),
	);
	$blocks[R2EP_BLOCK_TEAM] = array(
		'info' => t('R2EP Team Statistics'),
	);
	$blocks[R2EP_BLOCK_RUNNER] = array(
		'info' => t('R2EP Runner Statistics'),
	);
	$blocks[R2EP_BLOCK_THERMOMETER] = array(
		'info' => t('R2EP Goal Countdown'),
	);

	return $blocks;
}

function r2ep_stats_block_view($delta = '') {
	// $path = drupal_get_path('module', 'r2ep_stats');
	// drupal_add_css($path .'/css/r2ep_stats.css');
	$block = array();

	switch ($delta) {
		case R2EP_BLOCK_NATIONAL:
			$block['subject'] = t('National Statistics');
			$block['content'] = _r2ep_stats_national_stats();
			break;
		case R2EP_BLOCK_EVENT:
			$block['subject'] = t('Event Statistics');
			$block['content'] = _r2ep_stats_event_stats();
			break;
		case R2EP_BLOCK_TEAM:
			$block['subject'] = t('Team Statistics');
			$block['content'] = _r2ep_stats_team_stats();
			break;
		case R2EP_BLOCK_RUNNER:
			$block['subject'] = t('Runner Statistics');
			$block['content'] = _r2ep_stats_runner_stats();
			break;
		case R2EP_BLOCK_THERMOMETER:
			$block['subject'] = t('Help Reach Our Goal');
			$block['content'] = _r2ep_stats_thermometer();
			break;
	}

	return $block;
}

function _r2ep_stats_national_stats() {
	$block = array();

	$runner_count = _r2ep_stats_get_all_runners_count();
	$runners_label = $runner_count == 1 ? 'runner' : 'runners';

	$money = _r2ep_stats_get_all_donations_total();

	$teams_count = _r2ep_stats_get_all_teams_count();
	$teams_label = $teams_count == 1 ? 'team' : 'teams';

	$block = array(
		'#theme' => 'item_list',
		'#items' => array(),
		'#attributes' => array(
			'class' => 'stats-list'
		),
	);

	$path = drupal_get_path('module', 'r2ep_stats');
	$block['#items'][] = array(
		'data'	=> t('<a href="@url"><img src="/@path/images/@img" />@text</a>', array(
			'@url'	=> '/runners',
			'@path'	=> $path,
			'@img'	=> 'runners.png',
			'@text'	=> $runner_count .' '. $runners_label
		)),
		'class' => array('runners'),
	);
	$block['#items'][] = array(
		'data'	=> t('<img src="/@path/images/@img" />@text', array(
			'@path'	=> $path,
			'@img'	=> 'coin.png',
			'@text'	=> $money .' '. t('raised'),
		)),
		'class' => array('coin'),
	);
	$block['#items'][] = array(
		'data'	=> t('<a href="@url"><img src="/@path/images/@img" />@text</a>', array(
			'@url'	=> '/teams',
			'@path'	=> $path,
			'@img'	=> 'teams.png',
			'@text'	=> $teams_count .' '. t($teams_label)
		)),
		'class' => array('teams'),
	);

	return $block;
}

// updated
function _r2ep_stats_event_stats() {
	$block = array();
	$node = menu_get_object();

	if (!$node || $node->type != 'event') {
		return '';
	}

	$runners = @$node->field_runners_count['und'][0]['value'];
	$donations = @$node->field_total_donations['und'][0]['value'];
	$teams = @$node->field_teams_count['und'][0]['value'];

	$runners_label = $runners == 1 ? 'runner' : 'runners';
	setlocale(LC_MONETARY, 'en_US');
	$money = money_format('%.0n', $donations);
	$teams_label = $teams == 1 ? 'team' : 'teams';

	$block = array(
		'#theme' => 'item_list',
		'#items' => array(),
		'#attributes' => array(
			'class' => 'stats-list'
		),
	);

	$path = drupal_get_path('module', 'r2ep_stats');
	$block['#items'][] = array(
		'data'	=> t('<a href="@url"><img src="/@path/images/@img" />@text</a>', array(
			'@url'	=> '/runners?field_event_target_id='. $node->nid,
			'@path'	=> $path,
			'@img'	=> 'runners.png',
			'@text'	=> $runners .' '. $runners_label
		)),
		'class' => array('runners'),
	);
	$block['#items'][] = array(
		'data'	=> t('<img src="/@path/images/@img" />@text', array(
			'@path'	=> $path,
			'@img'	=> 'coin.png',
			'@text'	=> $money .' '. t('raised'),
		)),
		'class' => array('coin'),
	);
	$block['#items'][] = array(
		'data'	=> t('<a href="@url"><img src="/@path/images/@img" />@text</a>', array(
			'@url'	=> '/teams?field_event_target_id='. $node->nid,
			'@path'	=> $path,
			'@img'	=> 'teams.png',
			'@text'	=> $teams .' '. t($teams_label)
		)),
		'class' => array('teams'),
	);

	return $block;
}

// updated
function _r2ep_stats_team_stats() {
	$block = array();
	$node = menu_get_object();

	if (!$node || $node->type != 'team') {
	 	return '';
	}

	$runners = @count($node->field_runners['und']);
	$donations_total = @$node->field_total_donations['und'][0]['value'];
	$donations_count = @$node->field_donation_count['und'][0]['value'];

	$runners_label = $runners == 1 ? 'runner' : 'runners';
	setlocale(LC_MONETARY, 'en_US');
	$money = money_format('%.0n', $donations_total);
	$donations_label = $donations_count == 1? ' donation' : 'donations';

	$block = array(
		'#theme' => 'item_list',
		'#items' => array(),
		'#attributes' => array(
			'class' => 'stats-list'
		),
	);

	// FIXME change to goal
	$teams = array(); //_r2ep_stats_get_teams('TEAM');
	$teams_count = count($teams);
	$teams_label = $teams_count == 1 ? 'CHANGE' : 'CHANGE';

	$path = drupal_get_path('module', 'r2ep_stats');
	$block['#items'][] = array(
		'data'	=> t('<a href="@url"><img src="/@path/images/@img" />@text</a>', array(
			'@url'	=> '/runners?team_id='. $node->nid,
			'@path'	=> $path,
			'@img'	=> 'runners.png',
			'@text'	=> $runners .' '. $runners_label
		)),
		'class' => array('runners'),
	);
	$block['#items'][] = array(
		'data'	=> t('<img src="/@path/images/@img" />@text', array(
			'@path'	=> $path,
			'@img'	=> 'coin.png',
			'@text'	=> $money .' '. t('raised'),
		)),
		'class' => array('coin'),
	);
	$block['#items'][] = array(
		'data'	=> t('<img src="/@path/images/@img" />@text', array(
			'@path'	=> $path,
			'@img'	=> 'coin.png',
			'@text'	=> $donations_count .' '. t($donations_label)
		)),
		'class' => array('coin'),
	);

	return $block;
}

function _r2ep_stats_runner_stats() {
	$block = array();
	$uid = arg(1);
	if (!$uid) {
		return;
	}

	$user = user_load($uid);
	$campaigns = @$user->field_campaign_count['und'][0]['value'];
	$donations_count = @$user->field_donation_count['und'][0]['value'];
	$donations_total = @$user->field_total_donations['und'][0]['value'];

	$campaigns_label = $campaigns == 1 ? ' campaign' : ' campaign';
	setlocale(LC_MONETARY, 'en_US');
	$money = money_format('%.0n', $donations_total);
	$donations_label = $donations_count == 1? ' donation' : 'donations';

	$block = array(
		'#theme' => 'item_list',
		'#items' => array(),
		'#attributes' => array(
			'class' => 'stats-list'
		),
	);

	$path = drupal_get_path('module', 'r2ep_stats');
	$block['#items'][] = array(
		'data'	=> t('<img src="/@path/images/@img" />@text', array(
			'@path'	=> $path,
			'@img'	=> 'coin.png',
			'@text'	=> $campaigns .' '. $campaigns_label
		)),
		'class' => array('campaigns'),
	);
	$block['#items'][] = array(
		'data'	=> t('<img src="/@path/images/@img" />@text', array(
			'@path'	=> $path,
			'@img'	=> 'coin.png',
			'@text'	=> $money .' '. t('raised'),
		)),
		'class' => array('coin'),
	);
	$block['#items'][] = array(
		'data'	=> t('<img src="/@path/images/@img" />@text', array(
			'@path'	=> $path,
			'@img'	=> 'coin.png',
			'@text'	=> $donations_count .' '. t($donations_label)
		)),
		'class' => array('coin'),
	);

	return $block;
}


// computed fields
function computed_field_field_total_donations_compute(&$entity_field, $entity_type, $entity, $field, $instance, $langcode, $items) {

	if ($entity_type == 'user') {
		_r2ep_stats_total_donations_user($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
	} else if ($entity_type == 'node') {
		switch ($entity->type) {
			case 'campaign':
				_r2ep_stats_total_donations_campaign($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
				break;
			case 'event':
				_r2ep_stats_total_donations_event($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
				break;
			case 'team':
				_r2ep_stats_total_donations_team($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
				break;
		}
	}

}

function computed_field_field_donation_count_compute(&$entity_field, $entity_type, $entity, $field, $instance, $langcode, $items) {

	if ($entity_type == 'user') {
		_r2ep_stats_donation_count_user($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
	} else if ($entity_type == 'node') {
		switch ($entity->type) {
			case 'campaign':
				_r2ep_stats_donation_count_campaign($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
				break;
			case 'event':
				_r2ep_stats_donation_count_event($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
				break;
			case 'team':
				_r2ep_stats_donation_count_team($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
				break;
		}
	}
}

function computed_field_field_runners_count_compute(&$entity_field, $entity_type, $entity, $field, $instance, $langcode, $items) {

	if ($entity_type == 'node') {
		switch($entity->type) {
			case 'event':
				$entity_field[0]['value'] = _r2ep_stats_number_of_runners_for_event($entity->nid);
				break;
		}
	}
}

function computed_field_field_teams_count_compute(&$entity_field, $entity_type, $entity, $field, $instance, $langcode, $items) {
	if ($entity_type == 'node') {
		switch($entity->type) {
			case 'event':
				$entity_field[0]['value'] = _r2ep_stats_number_of_teams_for_event($entity->nid);
				break;
		}
	}
}

function computed_field_field_campaign_count_compute(&$entity_field, $entity_type, $entity, $field, $instance, $langcode, $items) {
	if ($entity_type == 'user') {
		$entity_field[0]['value'] = _r2ep_stats_number_of_campaigns_for_user($entity->uid);
	}
}

function computed_field_field_total_goal_compute(&$entity_field, $entity_type, $entity, $field, $instance, $langcode, $items) {
	if ($entity_type == 'user') {
		_r2ep_stats_donation_total_user($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
	} else if ($entity_type == 'node') {
		switch ($entity->type) {
			case 'campaign':
				_r2ep_stats_donation_total_campaign($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
				break;
			case 'event':
				_r2ep_stats_donation_total_event($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
				break;
			case 'team':
				_r2ep_stats_donation_total_team($entity_field, $entity_type, $entity, $field, $instance, $langcode, $items);
				break;
		}
	}
}

function _r2ep_stats_thermometer() {
	$content = array();
	$goal = 0;
	$current = 0;

	if (arg(0) === 'user') {
		$uid = arg(1);
		$user = user_load($uid);

		$goal = @$user->field_total_goal['und'][0]['value'];
		$current = @$user->field_total_donations['und'][0]['value'];
	} else {
		$node = menu_get_object();

		switch ($node->type) {
			case 'campaign':
				$goal = @$node->field_goal['und'][0]['value'];
				$current = @$node->field_total_donations['und'][0]['value'];
				break;
			case 'event':
				$goal = @$node->field_total_goal['und'][0]['value'];
				$current = @$node->field_total_donations['und'][0]['value'];
				break;
			case 'team':
				$goal = @$node->field_total_goal['und'][0]['value'];
				$current = @$node->field_total_donations['und'][0]['value'];
				break;
		}
	}

	if (!$goal) return;
	drupal_add_css(drupal_get_path('module', 'r2ep_stats') . '/r2ep_stats.css');

	$percent = $current/$goal * 100;
	setlocale(LC_MONETARY, 'en_US');
	$goal_money = money_format('%.0n', $goal);
	$half_money = money_format('%.0n', $goal/2);
	$current_money = money_format('%.0n', $current);

	$content['content'] = array(
		'#prefix' => '<div class="thermometer">',
		'#suffix' => '</div>',
	);
	$content['content']['details'] = array(
		'#prefix'	=> '<div class="gridContainer">',
		'#suffix'	=> '</div>',
		array(
			'#type'		=> 'markup',
			'#markup'	=> "<span>$current_money</span><br/>raised so far",
			'#prefix'	=> '<div class="col-1-2">',
			'#suffix'	=> '</div>',
		),
		array(
			'#type'		=> 'markup',
			'#markup'	=> "<span>$goal_money</span><br/>our goal",
			'#prefix'	=> '<div class="col-1-2">',
			'#suffix'	=> '</div>',
		)
	);
	$content['content']['guy'] = array(
		'#prefix'	=> '<div class="details">',
		'#suffix'	=> '</div>',
		array(
			'#type'		=> 'markup',
			'#markup'	=> "<div class=\"background\" style=\"height: $percent%\">&nbsp;</div><div class=\"mask\">&nbsp;</div>",
			'#prefix'	=> '<div class="chart">',
			'#suffix'	=> '</div>',
		),
		array(
			'#type'		=> 'markup',
			'#markup'	=> "<span class='top'>$goal_money</span><span class='middle'>$half_money</span><span class='bottom'>$0</span>",
			'#prefix'	=> '<div class="graph">',
			'#suffix'	=> '</div>',
		)
	);
	$content['content']['clear'] = array(
		'#type'		=> 'markup',
		'#markup'	=> '<div class="clear"></div>',
	);


	return $content;
}